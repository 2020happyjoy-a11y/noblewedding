<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>회원 정보 입력</title>
    <style>
        body { max-width: 600px; margin: 20px auto; font-family: Arial; }
        label { display: block; margin-top: 15px; font-weight: bold; }
        input, select, textarea {
            width: 100%; padding: 8px; margin-top: 5px;
            border: 1px solid #ccc; border-radius: 5px;
        }
        button {
            margin-top: 20px; padding: 12px;
            width: 100%; font-size: 16px;
            background-color: #1976d2; color: white;
            border: none; border-radius: 5px; cursor: pointer;
        }
        #loading { display: none; margin-top: 10px; color: #d32f2f; font-weight: bold; }
    </style>
</head>
<body>

    <h2>회원 정보 입력</h2>

    <form id="memberForm">

        <label>이름</label>
        <input type="text" id="name" required />

        <label>연락처</label>
        <input type="text" id="phone" placeholder="010-1234-5678" required />

        <label>주소</label>
        <input type="text" id="address" required />

        <label>이메일</label>
        <input type="email" id="email" required />

        <label>직업</label>
        <input type="text" id="job" />

        <label>학력</label>
        <input type="text" id="education" />

        <label>재산 정보 (선택)</label>
        <textarea id="assets" rows="3"></textarea>

        <label>졸업증명서 파일 업로드</label>
        <input type="file" id="gradFile" accept=".pdf,.jpg,.png" />

        <label>기타 증빙서류 업로드</label>
        <input type="file" id="extraFile" accept=".pdf,.jpg,.png" />

        <button type="submit">제출하기</button>
    </form>

    <div id="loading">저장 중입니다. 잠시만 기다려주세요...</div>

    <!-- Firebase CDN -->
    <script type="module">
        // --- Firebase SDK 불러오기 (CDN 버전) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

        // --- Firebase 설정 ---
        const firebaseConfig = {
            apiKey: "AIzaSyAfWEFCYDB9UQ-NktaR-CkjQGXOxPc6lMY",
            authDomain: "noble-wedding.firebaseapp.com",
            projectId: "noble-wedding",
            storageBucket: "noble-wedding.firebasestorage.app",
            messagingSenderId: "242816725640",
            appId: "1:242816725640:web:abc5dcfce08367789a653d",
            measurementId: "G-67MYW2RRSJ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const form = document.getElementById("memberForm");
        const loading = document.getElementById("loading");

        // 전화번호 자동 하이픈
        document.getElementById("phone").addEventListener("input", function(e) {
            let v = e.target.value.replace(/[^0-9]/g, "");
            if (v.length > 3 && v.length <= 7) v = v.replace(/(\d{3})(\d+)/, "$1-$2");
            else if (v.length > 7) v = v.replace(/(\d{3})(\d{4})(\d+)/, "$1-$2-$3");
            e.target.value = v;
        });

        // 파일 업로드 함수
        async function uploadIfExists(file, path) {
            if (!file) return "";
            const storageRef = ref(storage, `${path}/${Date.now()}_${file.name}`);
            await uploadBytes(storageRef, file);
            return await getDownloadURL(storageRef);
        }

        // 제출 기능
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            loading.style.display = "block";

            try {
                const gradUrl = await uploadIfExists(document.getElementById("gradFile").files[0], "graduation");
                const extraUrl = await uploadIfExists(document.getElementById("extraFile").files[0], "extra");

                await addDoc(collection(db, "members"), {
                    name: document.getElementById("name").value,
                    phone: document.getElementById("phone").value,
                    address: document.getElementById("address").value,
                    email: document.getElementById("email").value,
                    job: document.getElementById("job").value,
                    education: document.getElementById("education").value,
                    assets: document.getElementById("assets").value,
                    gradFileUrl: gradUrl,
                    extraFileUrl: extraUrl,
                    createdAt: serverTimestamp()
                });

                alert("정상적으로 저장되었습니다!");
                form.reset();
            } catch (err) {
                console.error(err);
                alert("저장 중 오류가 발생했습니다.");
            }

            loading.style.display = "none";
        });
    </script>
</body>
</html>
